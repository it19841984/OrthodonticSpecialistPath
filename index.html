<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>矯正歯科専門医 研修履歴管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
         {
            body { margin: 0; padding: 20px; }
            .no-print { display: none !important; }
            .print-break { page-break-inside: avoid; }
        }
        .training-table { border-collapse: collapse; width: 100%; }
        .training-table th, .training-table td { border: 1px solid #d1d5db; padding: 8px; text-align: center; }
        .valid-period { background-color: #dcfce7; }
        .invalid-period { background-color: #fef2f2; }
        .checkbox-matrix input[type="checkbox"] { transform: scale(1.2); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-blue-800 mb-8">
                <i class="fas fa-tooth mr-3"></i>矯正歯科専門医 研修履歴管理システム
            </h1>

            <!-- 基本設定セクション -->
            <div class="bg-blue-50 rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">
                    <i class="fas fa-cog mr-2"></i>基本設定
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">申請タイプ</label>
                        <select id="applicationType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">選択してください</option>
                            <option value="new">新規申請</option>
                            <option value="renewal">更新申請</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">申請年度</label>
                        <select id="applicationYear" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">まず申請タイプを選択してください</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 申請要件表示 -->
            <div id="requirementDisplay" class="bg-green-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-green-800 mb-4">
                    <i class="fas fa-clipboard-list mr-2"></i>申請要件
                </h2>
                <div id="requirementContent"></div>
            </div>

            <!-- 研修履歴入力 -->
            <div id="trainingHistorySection" class="bg-gray-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-table mr-2"></i>研修履歴入力
                </h2>
                
                <div class="overflow-x-auto">
                    <table id="trainingMatrix" class="training-table">
                        <thead>
                            <tr>
                                <th class="bg-gray-200">研修分野</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="bg-gray-100 font-medium">①医療倫理</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">②患者・医療者関係の構築</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">③医療安全</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">④院内感染対策</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">⑤医療関連法規・医療経済</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 2029年度以降の特別チェックボックス -->
                <div id="specialRequirement2029" class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg" style="display: none;">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="institutionalTrainingCheck" class="mt-1 transform scale-125">
                        <span class="text-sm text-gray-700">
                            共通研修区分「①医療倫理」「②患者・医療者関係の構築」「⑤医療関連法規・医療経済」について、それぞれ1単位（合計3単位）の日本歯科専門医機構主催研修の受講している。
                        </span>
                    </label>
                </div>

                <!-- その他研修追加 -->
                <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">その他研修追加</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">取得年度</label>
                            <input type="number" id="otherYear" class="w-full p-2 border border-gray-300 rounded-md" min="2020" max="2040">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">研修分野</label>
                            <select id="otherField" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="">選択してください</option>
                                <option value="0">①医療倫理</option>
                                <option value="1">②患者・医療者関係の構築</option>
                                <option value="2">③医療安全</option>
                                <option value="3">④院内感染対策</option>
                                <option value="4">⑤医療関連法規・医療経済</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="addOtherTraining" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                追加
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 進捗状況表示 -->
            <div id="progressSection" class="bg-purple-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">
                    <i class="fas fa-chart-line mr-2"></i>進捗状況
                </h2>
                <div id="progressContent"></div>
            </div>

            <!-- 操作ボタン -->
            <div class="flex justify-center space-x-4 no-print">
                <button id="saveBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    <i class="fas fa-print mr-2"></i>保存（印刷）
                </button>
            </div>
        </div>
    </div>

    <script>
        let trainingData = {};
        let currentApplicationType = '';
        let currentApplicationYear = '';

        // 申請タイプ変更時の処理
        document.getElementById('applicationType').addEventListener('change', function() {
            const type = this.value;
            currentApplicationType = type;
            const yearSelect = document.getElementById('applicationYear');
            
            yearSelect.innerHTML = '<option value="">選択してください</option>';
            
            if (type === 'new') {
                for (let year = 2026; year <= 2035; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + '年';
                    yearSelect.appendChild(option);
                }
            } else if (type === 'renewal') {
                const renewalOptions = [
                    { year: 2027, text: '2027年度申請（専門医期限2028年3月31日）' },
                    { year: 2028, text: '2028年度申請（専門医期限2029年3月31日）' },
                    { year: 2029, text: '2029年度申請（専門医期限2030年3月31日）' },
                    { year: 2030, text: '2030年度申請（専門医期限2031年3月31日）' },
                    { year: 2031, text: '2031年度申請（専門医期限2032年3月31日）' },
                    { year: 2032, text: '2032年度申請（専門医期限2033年3月31日）' },
                    { year: 2033, text: '2033年度申請（専門医期限2034年3月31日）' },
                    { year: 2034, text: '2034年度申請（専門医期限2035年3月31日）' },
                    { year: 2035, text: '2035年度申請（専門医期限2036年3月31日）' }
                ];
                
                renewalOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.year;
                    option.textContent = opt.text;
                    yearSelect.appendChild(option);
                });
            }
            
            hideAllSections();
        });

        // 申請年度変更時の処理
        document.getElementById('applicationYear').addEventListener('change', function() {
            const year = parseInt(this.value);
            currentApplicationYear = year;
            
            if (year && currentApplicationType) {
                showRequirements();
                generateTrainingMatrix();
                showProgressSection();
                checkSpecialRequirement2029();
            } else {
                hideAllSections();
            }
        });

        function hideAllSections() {
            document.getElementById('requirementDisplay').style.display = 'none';
            document.getElementById('trainingHistorySection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('specialRequirement2029').style.display = 'none';
        }

        function showRequirements() {
            const requirementDiv = document.getElementById('requirementDisplay');
            const contentDiv = document.getElementById('requirementContent');
            
            let targetPeriod, requiredUnits, fieldRequirement;
            
            if (currentApplicationType === 'new') {
                // 新規申請の計算
                if (currentApplicationYear <= 2027) {
                    targetPeriod = `2022年〜${currentApplicationYear - 1}年`;
                } else {
                    targetPeriod = `${currentApplicationYear - 5}年〜${currentApplicationYear - 1}年`;
                }
                
                if (currentApplicationYear === 2026) {
                    requiredUnits = '8単位';
                    fieldRequirement = '分野別の最低単位数制限なし';
                } else {
                    requiredUnits = '10単位以上';
                    if (currentApplicationYear >= 2029) {
                        fieldRequirement = '①～⑤の研修項目から各1分野から１単位以上を取得することが必須<br>そのうち①医療倫理、②患者・医療者関係の構築⑤医療関連法規・医療経済については、専門医機構主催の共通研修で各1単位（合計3単位）の受講が必須';
                    } else {
                        fieldRequirement = '各分野から1単位以上必須';
                    }
                }
            } else {
                // 更新申請の計算
                targetPeriod = `${currentApplicationYear - 5}年〜${currentApplicationYear - 1}年`;
                requiredUnits = '10単位';
                if (currentApplicationYear >= 2029) {
                    fieldRequirement = '①～⑤の研修項目から各1分野から１単位以上を取得することが必須<br>そのうち①医療倫理、②患者・医療者関係の構築⑤医療関連法規・医療経済については、専門医機構主催の共通研修で各1単位（合計3単位）の受講が必須';
                } else {
                    fieldRequirement = '各分野から1単位以上必須';
                }
            }
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">対象期間</h3>
                        <p class="text-lg">${targetPeriod}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">必要単位数</h3>
                        <p class="text-lg">${requiredUnits}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">分野別要件</h3>
                        <p class="text-sm">${fieldRequirement}</p>
                    </div>
                </div>
            `;
            
            requirementDiv.style.display = 'block';
        }

        function generateTrainingMatrix() {
            const table = document.getElementById('trainingMatrix');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // 年度範囲を計算（申請年度を含む過去7年）
            const startYear = currentApplicationYear - 6;
            const endYear = currentApplicationYear;
            
            // ヘッダーを再構築
            thead.innerHTML = '<th class="bg-gray-200">研修分野</th>';
            for (let year = startYear; year <= endYear; year++) {
                const th = document.createElement('th');
                th.className = 'bg-gray-200';
                th.textContent = year + '年';
                thead.appendChild(th);
            }
            
            // 対象期間を計算
            let validStartYear, validEndYear;
            if (currentApplicationType === 'new') {
                if (currentApplicationYear <= 2027) {
                    validStartYear = 2022;
                    validEndYear = currentApplicationYear - 1;
                } else {
                    validStartYear = currentApplicationYear - 5;
                    validEndYear = currentApplicationYear - 1;
                }
            } else {
                validStartYear = currentApplicationYear - 5;
                validEndYear = currentApplicationYear - 1;
            }
            
            // ボディを再構築
            const fields = ['①医療倫理', '②患者・医療者関係の構築', '③医療安全', '④院内感染対策', '⑤医療関連法規・医療経済'];
            tbody.innerHTML = '';
            
            fields.forEach((field, fieldIndex) => {
                const row = document.createElement('tr');
                
                const fieldCell = document.createElement('td');
                fieldCell.className = 'bg-gray-100 font-medium';
                fieldCell.textContent = field;
                row.appendChild(fieldCell);
                
                for (let year = startYear; year <= endYear; year++) {
                    const cell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'transform scale-125';
                    checkbox.dataset.year = year;
                    checkbox.dataset.field = fieldIndex;
                    
                    // 対象期間かどうかで色分け
                    if (year >= validStartYear && year <= validEndYear) {
                        cell.className = 'valid-period';
                    } else {
                        cell.className = 'invalid-period';
                    }
                    
                    checkbox.addEventListener('change', updateProgress);
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            });
            
            document.getElementById('trainingHistorySection').style.display = 'block';
        }

        function checkSpecialRequirement2029() {
            const specialDiv = document.getElementById('specialRequirement2029');
            if (currentApplicationYear >= 2029) {
                specialDiv.style.display = 'block';
                document.getElementById('institutionalTrainingCheck').addEventListener('change', updateProgress);
            } else {
                specialDiv.style.display = 'none';
            }
        }

        function showProgressSection() {
            document.getElementById('progressSection').style.display = 'block';
            updateProgress();
        }

        function updateProgress() {
            const progressContent = document.getElementById('progressContent');
            const fields = ['医療倫理', '患者・医療者関係の構築', '医療安全', '院内感染対策', '医療関連法規・医療経済'];
            
            // 対象期間を計算
            let validStartYear, validEndYear;
            if (currentApplicationType === 'new') {
                if (currentApplicationYear <= 2027) {
                    validStartYear = 2022;
                    validEndYear = currentApplicationYear - 1;
                } else {
                    validStartYear = currentApplicationYear - 5;
                    validEndYear = currentApplicationYear - 1;
                }
            } else {
                validStartYear = currentApplicationYear - 5;
                validEndYear = currentApplicationYear - 1;
            }
            
            // 各分野の単位数を計算
            const fieldCounts = [0, 0, 0, 0, 0];
            let totalUnits = 0;
            
            document.querySelectorAll('#trainingMatrix input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const year = parseInt(checkbox.dataset.year);
                    const field = parseInt(checkbox.dataset.field);
                    
                    if (year >= validStartYear && year <= validEndYear) {
                        fieldCounts[field]++;
                        totalUnits++;
                    }
                }
            });
            
            // 必要単位数を設定
            let requiredUnits;
            if (currentApplicationType === 'new' && currentApplicationYear === 2026) {
                requiredUnits = 8;
            } else {
                requiredUnits = 10;
            }
            
            // 分野別要件をチェック
            let fieldRequirementMet = true;
            let fieldRequirementText = '';
            
            if (currentApplicationType === 'new' && currentApplicationYear === 2026) {
                fieldRequirementMet = true;
                fieldRequirementText = '分野別制限なし';
            } else {
                fieldRequirementText = '各分野1単位以上必要';
                fieldCounts.forEach(count => {
                    if (count === 0) fieldRequirementMet = false;
                });
            }
            
            // 2029年度以降の特別要件チェック
            let institutionalRequirementMet = true;
            if (currentApplicationYear >= 2029) {
                const institutionalCheck = document.getElementById('institutionalTrainingCheck');
                institutionalRequirementMet = institutionalCheck && institutionalCheck.checked;
            }
            
            // 総合判定
            const totalRequirementMet = totalUnits >= requiredUnits;
            const allRequirementsMet = totalRequirementMet && fieldRequirementMet && institutionalRequirementMet;
            
            // 進捗表示を生成
            let progressHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-purple-700 mb-3">取得単位数</h3>
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl font-bold ${totalRequirementMet ? 'text-green-600' : 'text-red-600'}">
                                ${totalUnits} / ${requiredUnits}
                            </div>
                            <div class="flex-1 bg-gray-200 rounded-full h-3">
                                <div class="bg-${totalRequirementMet ? 'green' : 'red'}-500 h-3 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min(totalUnits / requiredUnits * 100, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-purple-700 mb-3">申請可能性</h3>
                        <div class="text-2xl font-bold ${allRequirementsMet ? 'text-green-600' : 'text-red-600'}">
                            ${allRequirementsMet ? '✅ 申請可能' : '❌ 申請不可'}
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 bg-white p-4 rounded-lg border">
                    <h3 class="font-semibold text-purple-700 mb-3">分野別進捗状況</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            `;
            
            fields.forEach((field, index) => {
                const count = fieldCounts[index];
                const required = (currentApplicationType === 'new' && currentApplicationYear === 2026) ? 0 : 1;
                const met = count >= required;
                
                progressHTML += `
                    <div class="text-center p-3 rounded-lg ${met ? 'bg-green-100' : 'bg-red-100'}">
                        <div class="font-medium text-sm mb-1">①${field}</div>
                        <div class="text-lg font-bold ${met ? 'text-green-600' : 'text-red-600'}">
                            ${count} / ${required}
                        </div>
                        <div class="text-xs ${met ? 'text-green-600' : 'text-red-600'}">
                            ${met ? '✅' : '❌'}
                        </div>
                    </div>
                `;
            });
            
            progressHTML += '</div></div>';
            
            // 不足項目の表示
            if (!allRequirementsMet) {
                progressHTML += '<div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="font-semibold text-red-700 mb-2">不足項目</h4><ul class="text-sm text-red-600 space-y-1">';
                
                if (!totalRequirementMet) {
                    progressHTML += `<li>• 総単位数が${requiredUnits - totalUnits}単位不足しています</li>`;
                }
                
                if (!fieldRequirementMet) {
                    fieldCounts.forEach((count, index) => {
                        if (count === 0) {
                            progressHTML += `<li>• ${fields[index]}の単位が不足しています</li>`;
                        }
                    });
                }
                
                if (!institutionalRequirementMet) {
                    progressHTML += '<li>• 機構主催研修の受講確認が必要です</li>';
                }
                
                progressHTML += '</ul></div>';
            }
            
            progressContent.innerHTML = progressHTML;
        }

        // その他研修追加機能
        document.getElementById('addOtherTraining').addEventListener('click', function() {
            const year = parseInt(document.getElementById('otherYear').value);
            const field = parseInt(document.getElementById('otherField').value);
            
            if (!year || field === '') {
                alert('年度と分野を選択してください');
                return;
            }
            
            // 該当するチェックボックスを探してチェック
            const checkbox = document.querySelector(`input[data-year="${year}"][data-field="${field}"]`);
            if (checkbox) {
                checkbox.checked = true;
                updateProgress();
            } else {
                alert('指定された年度は表示範囲外です');
            }
            
            // フィールドをクリア
            document.getElementById('otherYear').value = '';
            document.getElementById('otherField').value = '';
        });

        // PDF保存機能
        document.getElementById('saveBtn').addEventListener('click', function() {
            window.print();
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDrfduXGs8WCwdwOKOyz6fUT1AzIDqeC672IpsnhDO6yV1LDyKdl3ykemY%2B8jCIhkgwArwwFl%2F5YFZjIA3SebrbgdUSm2uadF2vxrsRsizzhEugfi3kPr2yvMN69bQ0CH1vch1GTPvssy1nS1pS0y3zUT3X8%2FjtIsCJD4TluQKhvxK4nfYRRyyp16apIVh3fSgLGM4qWysqNMdz8oT8ICjxsv1BotUGPlFNRIAdYeX9XljVE9PKBefI5o4UQoxVWdUH89baSp24y6B%2B%2Fj1H5HVqTcP3n2BgdCA8x9x%2FykEd4Dn8tChZxSJZC0zIpV%2FhEppW%2BvAvVC608fp2b%2F8tq7dNwaHjLu%2B8ss1mXZ%2BZrakGJUOhN6vRK2vBSZvOi1iG%2BTPSBBtiGCEVa5hFbS1gkSYaefRP6SbpVnFlSTovfP4WQC4rnzPQryk480BL%2BQPv4bk4aAE7PHqJ5bW2QyI2ZnQLsfm2J1cbVl9fD3cJWysjYHbGjdGKMzyaS1ljCqucFoG99e3rx%2BMIBW%2F2lK3eaCD4NLMYlSi3oaQA%2F5zdD%2Bv1Ft";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDrfduXGs8WCwdwOKOyz6fUT1AzIDqeC672IpsnhDO6yV1LDyKdl3ykemY+8jCIhkgwArwwFl/5YFZjIA3SebrbgdUSm2uadF2vxrsRsizzhEugfi3kPr2yvMN69bQ0CH1vch1GTPvssy1nS1pS0y3zUT3X8/jtIsCJD4TluQKhvxK4nfYRRyyp16apIVh3fSgLGM4qWysqNMdz8oT8ICjxsv1BotUGPlFNRIAdYeX9XljVE9PKBefI5o4UQoxVWdUH89baSp24y6B+/j1H5HVqTcP3n2BgdCA8x9x/ykEd4Dn8tChZxSJZC0zIpV/hEppW+vAvVC608fp2b/8tq7dNwaHjLu+8ss1mXZ+ZrakGJUOhN6vRK2vBSZvOi1iG+TPSBBtiGCEVa5hFbS1gkSYaefRP6SbpVnFlSTovfP4WQC4rnzPQryk480BL+QPv4bk4aAE7PHqJ5bW2QyI2ZnQLsfm2J1cbVl9fD3cJWysjYHbGjdGKMzyaS1ljCqucFoG99e3rx+MIBW/2lK3eaCD4NLMYlSi3oaQA/5zdD+v1Ft";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
